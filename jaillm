#!/usr/bin/env bash
#
# A script to run a jailed language model in Nix (or Docker).
#
# Usage:
#
# $ ./jaillm [-f|--file <path>] [run|init]

set -eou pipefail

# Default values
filepath="jaillm.nix"
command="run"

# Show usage information
usage() {
    echo "Usage: jaillm [-f|--file <path>] [command]"
    echo ""
    echo "Commands:"
    echo "  run    Run the jailed LLM (default)"
    echo "  init   Create a jaillm.nix file"
    echo ""
    echo "Options:"
    echo "  -f, --file <path>  Path to jaillm.nix file (default: jaillm.nix)"
    echo "  -h, --help         Show this help message"
}

# Run command
cmd_run() {
    # If not a file, fail
    if [ ! -f "$filepath" ]; then
        echo "Error: File '$filepath' not found."
        exit 1
    fi

    export JAILLM_FLAKE=${JAILLM_FLAKE:-"github:myme/jaillm"}
    export JAILLM_NIX="$(readlink -f "$filepath")"

    nix run --impure --expr '
let
  jaillm = builtins.getFlake (builtins.getEnv "JAILLM_FLAKE");
  config = import (builtins.getEnv "JAILLM_NIX");
in
  jaillm.lib.build (import <nixpkgs>) config
'
}

# Init command
cmd_init() {
    if [ -f "$filepath" ]; then
        echo "Error: File '$filepath' already exists."
        exit 1
    fi

    cat > "$filepath" << 'EOF'
pkgs:
{
  entry = pkgs.bashInteractive;
  llms = [ pkgs.claude-code pkgs.gemini-cli ];
  extraUtils = [
    pkgs.curl
  ];
}
EOF

    echo "Created '$filepath'"
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -f|--file)
            filepath="$2"
            shift 2
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        run)
            command="run"
            shift
            ;;
        init)
            command="init"
            shift
            ;;
        *)
            echo "Error: Unknown option or command '$1'"
            usage
            exit 1
            ;;
    esac
done

# Execute the command
case $command in
    run)
        cmd_run
        ;;
    init)
        cmd_init
        ;;
esac
